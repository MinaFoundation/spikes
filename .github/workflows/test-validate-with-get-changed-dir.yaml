on:
  workflow_call:
    inputs:
      pattern:
        description: 'Regex pattern to match the directory names'
        required: true
        type: string
    outputs:
      changed_dir_list:
        description: 'List of changed directories'
        value: ${{ jobs.get-changed-directories.outputs.matrix }}

jobs:
  get-changed-directories:
    name: Get changed directories
    runs-on: minafoundation-default-runners
    outputs:
      matrix: ${{ steps.get-changed-directories.outputs.changed_dir_list }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: ðŸ—‚ï¸ Get changed directories
        id: get-changed-directories
        env:
          PATTERN: '^[^\.].*.yaml$'
        run: |
            event_type=${{ github.event_name }} # push, pull_request
            if [ "$event_type" = "pull_request" ]; then
                BASE_REF=${{ github.event.pull_request.base.ref }}
                git fetch origin $BASE_REF
                GIT_DIFF=$(git diff --name-only origin/$BASE_REF | grep -E "$PATTERN" | xargs -I {} dirname {} | sort -u)
            else
                BASE_REF=$(git log --oneline | sed -n '2p' | awk '{print $1}') # Get previous commit hash
                GIT_DIFF=$(git diff --name-only $BASE_REF | grep -E "$PATTERN" | xargs -I {} dirname {} | sort -u)
            fi
            [ -z "$GIT_DIFF" ] && echo "changed_dir_list=[]" >> $GITHUB_OUTPUT && exit 0
            CHANGED_DIR_LIST="[$(echo "$GIT_DIFF" | sed 's/ /\n/g' | awk '{printf "\"%s\", ", $0}' | sed 's/, $/\n/')]"
            EXISTING_DIR_LIST=$(git ls-tree -d --name-only -r HEAD)
            EXISTING_CHANGED_DIR_LIST=$(comm -12 <(echo "$CHANGED_DIR_LIST" | tr ' ' '\n' | sort) <(echo "$EXISTING_DIR_LIST" | tr ' ' '\n' | sort))
            echo "$EXISTING_CHANGED_DIR_LIST"
            echo "changed_dir_list=$CHANGED_DIR_LIST" >> $GITHUB_OUTPUT


